<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Christian y Clara üíñ - Horarios</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    :root{
      --primary-color:#e84393; --secondary-color:#fd79a8; --accent-color:#a29bfe;
      --mochito:#6c5ce7; --mochita:#fd79a8; --card-bg:#fff; --shadow:0 15px 30px rgba(0,0,0,.08);
      --text:#2d3436; --gradient:linear-gradient(135deg,#e84393, #fd79a8 50%, #a29bfe);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family:'Montserrat',sans-serif; background:linear-gradient(135deg,#ffe8f3,#dfe6e9);
      color:var(--text); min-height:100vh; padding:16px;
    }
    .container{
      background:var(--card-bg); border-radius:20px; box-shadow:var(--shadow);
      overflow:hidden; max-width:1600px; margin:24px auto;
      border:1px solid rgba(255,255,255,.6);
    }
    header{
      background:var(--gradient); color:#fff; text-align:center; padding:22px 16px; position:relative;
    }
    header h1{ font-family:'Dancing Script',cursive; font-size:42px; text-shadow:0 3px 6px rgba(0,0,0,.2); }
    .user-selector{ display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
    .user-btn{
      padding:10px 14px; border:none; border-radius:999px; background:rgba(255,255,255,.2);
      color:#fff; font-weight:700; cursor:pointer; backdrop-filter:blur(4px);
      border:2px solid rgba(255,255,255,.35); transition:.25s;
    }
    .user-btn:hover{ transform:translateY(-2px); background:rgba(255,255,255,.3); }
    .user-btn.active{ background:#fff; color:var(--primary-color); }
    .calendar-container{ padding:18px; overflow:auto; }
    table{ width:100%; min-width:760px; border-collapse:collapse; table-layout:fixed; }
    th,td{ border:1px solid #eee; text-align:center; padding:8px; }
    th{ background:#fafafa; position:sticky; top:0; z-index:1; font-weight:700; }
    .hour-cell{ width:90px; background:#f0f0f0; font-weight:700; position:relative; }
    .delete-time-btn{
      position:absolute; top:2px; right:2px; border:none; background:transparent; color:#ff6b6b;
      cursor:pointer; font-size:12px; opacity:.7;
    }
    .delete-time-btn:hover{ opacity:1; transform:scale(1.1); }
    .schedule-cell{ position:relative; min-height:50px; }
    .schedule-cell.editable{ cursor:pointer; }
    .activity{
      font-size:.78rem; font-weight:600; color:#fff; padding:6px 8px; border-radius:8px;
      margin:3px 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .activity[draggable="true"]{ cursor:grab; }
    .activity.dragging{ opacity:.6; transform:scale(.98); }

    /* Conflictos y drop targets */
    .schedule-cell.conflict{ outline:2px solid #e74c3c; outline-offset:-2px; }
    .schedule-cell.drop-target{ background:#f0fff7; }

    .controls{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 16px; background:#fafafa; border-top:1px solid #eee;
    }
    .view-selector{ display:flex; gap:10px; flex-wrap:wrap; }
    .view-btn{
      padding:8px 14px; border:none; border-radius:999px; background:#eee; font-weight:700; cursor:pointer; transition:.25s;
    }
    .view-btn:hover{ transform:translateY(-2px); }
    .view-btn.active{ color:#fff; background:var(--primary-color); }
    .add-time-btn, .save-btn{
      padding:10px 16px; border:none; border-radius:999px; font-weight:700; cursor:pointer; transition:.3s;
      box-shadow:0 6px 14px rgba(0,0,0,.08);
    }
    .add-time-btn{ background:var(--accent-color); color:#fff; }
    .add-time-btn:hover{ filter:brightness(1.05); transform:translateY(-2px); }
    .save-btn{ background:var(--gradient); color:#fff; }
    .save-btn:hover{ filter:brightness(1.05); transform:translateY(-2px); }

    .custom-time{
      display:flex; gap:10px; align-items:center; padding:12px 16px; justify-content:center; flex-wrap:wrap;
    }
    .custom-time label{ font-weight:700; }
    .custom-time input{
      width:80px; text-align:center; padding:10px 12px; border-radius:10px; border:2px solid #eee; background:#fff;
      font-weight:700;
    }

    /* Modal base */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:1000; align-items:center; justify-content:center; padding:16px; }
    .modal-content{ background:#fff; border-radius:16px; width:100%; max-width:520px; padding:20px; position:relative; max-height:90vh; overflow:auto; box-shadow:0 24px 60px rgba(0,0,0,.35); }
    .modal h3{ text-align:center; color:var(--primary-color); margin-bottom:12px; font-family:'Dancing Script',cursive; font-size:32px; }

    .form-group{ margin-bottom:12px; }
    .form-group label{ display:block; margin-bottom:6px; font-weight:700; }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select{
      width:100%; border:2px solid #eee; border-radius:10px; padding:10px 12px; background:#fafafa; font-weight:600;
    }
    .time-row{ display:flex; gap:8px; align-items:center; justify-content:center; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .chip{ padding:6px 10px; border-radius:999px; border:2px solid #eee; background:#f8f8f8; font-weight:700; cursor:pointer; }

    .form-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:16px; }
    .btn{ padding:10px 14px; border:none; border-radius:999px; font-weight:700; cursor:pointer; }
    .btn-cancel{ background:#eee; }
    .btn-delete{ background:#ff7675; color:#fff; margin-right:auto; }
    .btn-primary{ background:var(--gradient); color:#fff; }

    /* Modal huecos comunes */
    .common-slots-modal .modal-content{ max-width:680px; }
    .common-slots-list{ display:grid; gap:8px; margin-top:8px; }
    .common-slot{ padding:10px 12px; border-radius:12px; border:1px solid #eee; background:#fafafa; font-weight:700; }

    /* Men√∫ contextual */
    .context-menu{
      position:fixed; top:0; left:0; z-index:1500; display:none;
      background:#fff; border:1px solid #e6e6e6; border-radius:10px; box-shadow:0 16px 40px rgba(0,0,0,.18);
      min-width:220px; overflow:hidden;
    }
    .context-menu .cm-header{
      padding:10px 12px; font-weight:800; background:#fafafa; border-bottom:1px solid #eee; font-size:.9rem;
    }
    .context-menu button{
      display:flex; align-items:center; gap:10px; width:100%; text-align:left; border:none; background:#fff; cursor:pointer;
      padding:10px 12px; font-weight:700;
    }
    .context-menu button:hover{ background:#f7f7f7; }
    .context-menu .cm-sep{ height:1px; background:#eee; margin:4px 0; }

    /* Back btn */
    .back-btn{
      position:fixed; top:14px; left:14px; background:#fff; color:var(--primary-color);
      padding:10px 14px; border-radius:999px; text-decoration:none; font-weight:700; box-shadow:var(--shadow); z-index:1200;
    }
    .back-btn:hover{ background:var(--primary-color); color:#fff; }

    @media (max-width:640px){
      header h1{ font-size:34px; }
      .hour-cell{ width:72px; }
      .activity{ font-size:.72rem; }
      .context-menu{ min-width:200px; }
    }
  </style>
</head>
<body>
  <a class="back-btn" href="/"><i class="fa-solid fa-arrow-left"></i> Volver</a>

  <div class="container">
    <header>
      <h1>Horarios</h1>
      <div class="user-selector">
        <button class="user-btn active" data-user="both">Ver Ambos</button>
        <button class="user-btn" data-user="mochito">Solo Mochito</button>
        <button class="user-btn" data-user="mochita">Solo Mochita</button>
      </div>
    </header>

    <div class="custom-time">
      <label>Hora personalizada:</label>
      <input type="number" id="custom-hour" min="0" max="23" placeholder="Hora" value="8"/>
      <span>:</span>
      <input type="number" id="custom-minute" min="0" max="59" placeholder="Min" value="0"/>
      <button class="add-time-btn" id="add-time-btn"><i class="fa-solid fa-plus"></i> Agregar</button>
    </div>

    <div class="calendar-container">
      <table id="schedule-table">
        <thead>
        <tr>
          <th class="hour-cell">HORAS</th>
          <th>LUNES</th>
          <th>MARTES</th>
          <th>MI√âRCOLES</th>
          <th>JUEVES</th>
          <th>VIERNES</th>
          <th>S√ÅBADO</th>
          <th>DOMINGO</th>
        </tr>
        </thead>
        <tbody><!-- filas generadas por JS --></tbody>
      </table>
    </div>

    <div class="controls">
      <div class="view-selector">
        <button class="view-btn active" data-view="week">Vista Semanal</button>
        <button class="view-btn" data-view="mochito">Solo Mochito</button>
        <button class="view-btn" data-view="mochita">Solo Mochita</button>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="add-time-btn" id="btn-common-slots">
          <i class="fa-solid fa-magnifying-glass"></i> Huecos comunes
        </button>

        <button class="add-time-btn" id="btn-export">
          <i class="fa-solid fa-file-export"></i> Exportar
        </button>

        <label for="import-file" class="add-time-btn" style="cursor:pointer;">
          <i class="fa-solid fa-file-import"></i> Importar
        </label>
        <input type="file" id="import-file" accept="application/json" style="display:none;">
        <button class="save-btn" id="save-btn"><i class="fa-solid fa-save"></i> Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal editar -->
  <div class="modal" id="event-modal">
    <div class="modal-content">
      <h3>Editar Actividad</h3>

      <div class="form-group">
        <label for="activity-day">D√≠a</label>
        <input type="text" id="activity-day" readonly>
      </div>

      <div class="form-group">
        <label>Hora</label>
        <div class="time-row">
          <input type="number" id="activity-hour" min="0" max="23" placeholder="Hora" style="width:90px;">
          <span>:</span>
          <input type="number" id="activity-minute" min="0" max="59" placeholder="Min" style="width:90px;">
        </div>
      </div>

      <div class="form-group">
        <label for="activity-text">Actividad</label>
        <input type="text" id="activity-text" placeholder="Describe tu actividad">
      </div>

      <!-- PALETA: color libre -->
      <div class="form-group" style="text-align:center;">
        <label for="activity-color" style="display:block; margin-bottom:6px; font-weight:700;">Color</label>
        <input type="color" id="activity-color" value="#e84393" style="width:64px; height:38px; padding:0; border:none; background:transparent; cursor:pointer;"/>
      </div>

      <!-- Aplicar a varios d√≠as -->
      <div class="form-group">
        <label>Aplicar tambi√©n a:</label>
        <div class="chips" id="apply-days">
          <label class="chip"><input type="checkbox" class="apply-day" value="LUNES"> L</label>
          <label class="chip"><input type="checkbox" class="apply-day" value="MARTES"> M</label>
          <label class="chip"><input type="checkbox" class="apply-day" value="MI√âRCOLES"> X</label>
          <label class="chip"><input type="checkbox" class="apply-day" value="JUEVES"> J</label>
          <label class="chip"><input type="checkbox" class="apply-day" value="VIERNES"> V</label>
          <label class="chip"><input type="checkbox" class="apply-day" value="S√ÅBADO"> S</label>
          <label class="chip"><input type="checkbox" class="apply-day" value="DOMINGO"> D</label>
        </div>
      </div>

      <div class="form-group" style="text-align:center;">
        <label><input type="checkbox" id="repeat-weekly"> Repetir cada semana (visual)</label>
      </div>

      <div class="form-actions">
        <button class="btn btn-delete" id="delete-btn">Eliminar</button>
        <button class="btn btn-cancel" id="cancel-btn">Cancelar</button>
        <button class="btn btn-primary" id="confirm-btn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal huecos comunes -->
  <div class="modal common-slots-modal" id="common-slots-modal">
    <div class="modal-content">
      <h3>Huecos comunes</h3>

      <div class="form-group" style="text-align:center;">
        <label>Duraci√≥n m√≠nima:
          <select id="min-duration">
            <option value="30">30 min</option>
            <option value="60" selected>60 min</option>
            <option value="90">90 min</option>
            <option value="120">120 min</option>
          </select>
        </label>
        <button class="add-time-btn" id="refresh-common"><i class="fa-solid fa-rotate"></i> Recalcular</button>
      </div>

      <div id="common-slots-list" class="common-slots-list"></div>

      <div class="form-actions">
        <button class="btn btn-cancel" id="close-common">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Men√∫ contextual -->
  <div id="context-menu" class="context-menu" role="menu" aria-hidden="true"></div>

<script>
  // ========================
  // Estado y helpers
  // ========================
  const DAYS = ['LUNES','MARTES','MI√âRCOLES','JUEVES','VIERNES','S√ÅBADO','DOMINGO'];

  let currentUser = 'both';   // both | mochito | mochita (para editar)
  let currentView = 'week';   // week | mochito | mochita (para ver)
  let schedules   = { mochito:{}, mochita:{} }; // { user: { DAY: { HH:MM: {activity,color} } } }
  let customTimes = { mochito:[], mochita:[] }; // visibilidad de filas
  let selectedCell = null;
  let originalTime = null;
  let selectedColor = '#e84393';

  const fallbackDefaultTimes = ["8:00","9:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00"];

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function pad2(n){ return String(n).padStart(2,'0'); }
  function fmt(h,m){ return `${parseInt(h||0)}:${pad2(parseInt(m||0))}`; }
  function parseHM(s){ const [h,m='0']=s.split(':'); return {h:+h||0, m:+m||0}; }

  function cmpTime(a,b){
    const A=parseHM(a), B=parseHM(b);
    if(A.h!==B.h) return A.h-B.h;
    return A.m-B.m;
  }
  function uniqSorted(arr){ return Array.from(new Set(arr)).sort(cmpTime); }

  function timesFromUser(userKey){
    const obj = schedules[userKey] || {};
    const set = new Set();
    Object.values(obj).forEach(dayObj=>{
      if(dayObj) Object.keys(dayObj).forEach(t=> set.add(t));
    });
    return Array.from(set);
  }

  // Deduce tama√±o de slot en minutos (si es irregular, devuelve 60)
  function guessSlotMinutes(allTimes){
    if(allTimes.length<2) return 60;
    const diffs = [];
    for(let i=1;i<allTimes.length;i++){
      const a=parseHM(allTimes[i-1]), b=parseHM(allTimes[i]);
      diffs.push((b.h-a.h)*60 + (b.m-a.m));
    }
    diffs.sort((x,y)=>x-y);
    const mid = diffs[Math.floor(diffs.length/2)] || 60;
    if(!isFinite(mid) || mid<=0 || mid>240) return 60;
    return mid;
  }

  // ========================
  // Carga / guardado
  // ========================
  async function loadSchedules(){
    try{
      const res = await fetch('/api/schedules',{headers:{'Accept':'application/json'}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      schedules = { mochito:data.schedules?.mochito||{}, mochita:data.schedules?.mochita||{} };
      const tM = data.customTimes?.mochito || [];
      const tC = data.customTimes?.mochita || [];
      const mixM = uniqSorted([...tM, ...timesFromUser('mochito')]);
      const mixC = uniqSorted([...tC, ...timesFromUser('mochita')]);
      customTimes.mochito = mixM.length? mixM : [...fallbackDefaultTimes];
      customTimes.mochita = mixC.length? mixC : [...fallbackDefaultTimes];
    }catch(e){
      console.error(e);
      schedules = { mochito:{}, mochita:{} };
      customTimes.mochito = [...fallbackDefaultTimes];
      customTimes.mochita = [...fallbackDefaultTimes];
    }
    renderTable();
  }

  async function saveSchedules(){
    const btn = $('#save-btn');
    const old = btn.innerHTML; btn.disabled=true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
    try{
      const payload = { schedules, customTimes };
      const res = await fetch('/api/schedules/save',{
        method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if(!res.ok || !j.ok) throw new Error('Save error');
      alert('Horarios guardados ‚úÖ');
    }catch(e){
      alert('No se pudo guardar. Intenta de nuevo.');
    }finally{
      btn.disabled=false; btn.innerHTML = old;
    }
  }

  // ========================
  // Render tabla + conflictos + DnD
  // ========================
  function visibleTimes(){
    if(currentView==='week'){
      return uniqSorted([
        ...customTimes.mochito, ...customTimes.mochita,
        ...timesFromUser('mochito'), ...timesFromUser('mochita')
      ]);
    }
    const key = currentView==='mochito'?'mochito':'mochita';
    return uniqSorted([...customTimes[key], ...timesFromUser(key)]);
  }

  function renderTable(){
    const tbody = $('#schedule-table tbody'); tbody.innerHTML='';
    const times = visibleTimes();

    times.forEach(t=>{
      const tr = document.createElement('tr');

      const th = document.createElement('td');
      th.className='hour-cell'; th.textContent=t;

      if(currentView!=='week'){
        const del = document.createElement('button');
        del.className='delete-time-btn'; del.title = 'Eliminar hora';
        del.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        del.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          deleteTime(t, currentView);
        });
        th.appendChild(del);
      }

      tr.appendChild(th);

      DAYS.forEach(day=>{
        const td = document.createElement('td');
        td.className='schedule-cell';
        td.dataset.time = t; td.dataset.day = day;

        // Mostrar actividades seg√∫n vista
        if(currentView==='week' || currentView==='mochito'){
          const a = schedules.mochito?.[day]?.[t];
          if(a) td.appendChild(makeActivityBadge('M: '+a.activity, a.color, 'mochito', day, t));
        }
        if(currentView==='week' || currentView==='mochita'){
          const a = schedules.mochita?.[day]?.[t];
          if(a) td.appendChild(makeActivityBadge('C: '+a.activity, a.color, 'mochita', day, t));
        }

        // Editable si no estamos en "both"
        if(currentUser!=='both') td.classList.add('editable');
        if(td.classList.contains('editable')){
          td.addEventListener('click',(e)=>{
            if(e.target.classList.contains('activity')) return;
            openEditModal(td); // usa currentUser
          });
        }

        // Men√∫ contextual (clic derecho)
        td.addEventListener('contextmenu', (e)=>{
          e.preventDefault();
          openContextMenu(e.clientX, e.clientY, td);
        });

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    // Marcar conflictos
    markConflicts();
    // Activar DnD
    enableDragAndDrop();
  }

  function makeActivityBadge(text, color, owner, day, time){
    const d = document.createElement('div');
    d.className='activity'; d.textContent=text; d.style.background=color||'#888';
    if(currentUser===owner){
      d.setAttribute('draggable','true');
      d.dataset.owner = owner;
      d.dataset.day = day;
      d.dataset.time= time;
    }
    return d;
  }

  function markConflicts(){
    $$('#schedule-table tbody .schedule-cell').forEach(td=>{
      const day = td.dataset.day, time = td.dataset.time;
      const m = !!(schedules.mochito?.[day]?.[time]);
      const c = !!(schedules.mochita?.[day]?.[time]);
      td.classList.toggle('conflict', m && c);
    });
  }

  function enableDragAndDrop(){
    if(currentUser==='both') return;

    let dragging = null;

    $$('#schedule-table .activity[draggable="true"]').forEach(el=>{
      el.addEventListener('dragstart',(e)=>{
        dragging = el; el.classList.add('dragging');
        e.dataTransfer.effectAllowed='move';
      });
      el.addEventListener('dragend',()=>{
        if(dragging){ dragging.classList.remove('dragging'); dragging=null; }
        $$('.schedule-cell.drop-target').forEach(c=> c.classList.remove('drop-target'));
      });
    });

    $$('#schedule-table .schedule-cell').forEach(cell=>{
      cell.addEventListener('dragover',(e)=>{
        if(!dragging) return;
        e.preventDefault();
        cell.classList.add('drop-target');
      });
      cell.addEventListener('dragleave',()=> cell.classList.remove('drop-target'));
      cell.addEventListener('drop',()=>{
        if(!dragging) return;
        const owner = dragging.dataset.owner;
        if(owner!==currentUser) return;

        const fromDay  = dragging.dataset.day;
        const fromTime = dragging.dataset.time;
        const toDay    = cell.dataset.day;
        const toTime   = cell.dataset.time;

        const obj = schedules[owner]?.[fromDay]?.[fromTime];
        if(!obj) return;

        if(!schedules[owner][toDay]) schedules[owner][toDay]={};
        schedules[owner][toDay][toTime] = {...obj};
        delete schedules[owner][fromDay][fromTime];

        renderTable();
      });
    });
  }

  // ========================
  // CRUD de horas y actividades
  // ========================
  function deleteTime(time, userView){
    if(!confirm(`¬øEliminar la hora ${time} de ${userView}?`)) return;
    const key = userView==='mochito' ? 'mochito' : 'mochita';
    customTimes[key] = customTimes[key].filter(t=> t!==time);
    DAYS.forEach(d=>{
      if(schedules[key]?.[d]?.[time]) delete schedules[key][d][time];
    });
    renderTable();
  }

  // openEditModal con override opcional de usuario
  function openEditModal(cell, userOverride){
    selectedCell = cell;
    originalTime = cell.dataset.time;
    $('#activity-day').value = cell.dataset.day;

    const {h,m} = parseHM(originalTime);
    $('#activity-hour').value = h;
    $('#activity-minute').value = m;

    const key = userOverride || (currentUser==='mochito' ? 'mochito' : (currentUser==='mochita' ? 'mochita' : 'mochito'));
    const existing = schedules[key]?.[cell.dataset.day]?.[originalTime];

    $('#activity-text').value = existing?.activity || '';
    selectedColor = existing?.color || '#e84393';
    $('#activity-color').value = toColorInputValue(selectedColor);

    $('#repeat-weekly').checked=false;
    $$('#apply-days .apply-day').forEach(c=> c.checked=false);

    // Guardamos un flag en el modal para saber con qu√© user estamos editando
    $('#event-modal').dataset.user = key;

    $('#event-modal').style.display='flex';
    closeContextMenu();
  }

  function toColorInputValue(c){
    // admite formatos #RGB/#RRGGBB; si no, por defecto
    if(/^#[0-9a-fA-F]{3}$/.test(c)){
      const r=c[1], g=c[2], b=c[3];
      return `#${r}${r}${g}${g}${b}${b}`;
    }
    if(/^#[0-9a-fA-F]{6}$/.test(c)) return c.toLowerCase();
    return '#e84393';
  }

  function closeEditModal(){ $('#event-modal').style.display='none'; }

  function saveActivity(){
    const day = $('#activity-day').value;
    const h = $('#activity-hour').value, m = $('#activity-minute').value;
    const newTime = fmt(h,m);
    const text = $('#activity-text').value.trim();
    const key = $('#event-modal').dataset.user || (currentUser==='mochito'?'mochito':'mochita');

    selectedColor = $('#activity-color').value || '#e84393';

    if(!customTimes[key].includes(newTime)){
      customTimes[key].push(newTime);
      customTimes[key] = uniqSorted(customTimes[key]);
    }
    if(!schedules[key][day]) schedules[key][day]={};

    if(!text){
      if(schedules[key][day]?.[originalTime]) delete schedules[key][day][originalTime];
    }else{
      if(originalTime!==newTime && schedules[key][day]?.[originalTime]){
        delete schedules[key][day][originalTime];
      }
      schedules[key][day][newTime] = { activity:text + ( $('#repeat-weekly').checked ? ' ‚ü≤' : '' ), color:selectedColor };
    }

    const alsoDays = $$('#apply-days .apply-day:checked').map(c=> c.value).filter(d=> d!==day);
    alsoDays.forEach(d=>{
      if(!schedules[key][d]) schedules[key][d]={};
      schedules[key][d][newTime] = { activity:text + ( $('#repeat-weekly').checked ? ' ‚ü≤' : '' ), color:selectedColor };
    });

    closeEditModal();
    renderTable();
  }

  function deleteActivityFor(userKey, day, time){
    if(schedules[userKey]?.[day]?.[time]){
      delete schedules[userKey][day][time];
      renderTable();
    }
  }

  function deleteActivity(){
    const day = $('#activity-day').value;
    const key = $('#event-modal').dataset.user || (currentUser==='mochito'?'mochito':'mochita');
    if(schedules[key]?.[day]?.[originalTime]){
      delete schedules[key][day][originalTime];
    }
    closeEditModal();
    renderTable();
  }

  // ========================
  // Huecos comunes
  // ========================
  function openCommonModal(){
    $('#common-slots-modal').style.display='flex';
    computeCommonSlots();
    closeContextMenu();
  }
  function closeCommonModal(){ $('#common-slots-modal').style.display='none'; }

  function computeCommonSlots(){
    const list = $('#common-slots-list'); list.innerHTML='';
    const times = visibleTimes();
    if(!times.length){ list.innerHTML='<div class="common-slot">No hay horas configuradas.</div>'; return; }

    const slotMin = guessSlotMinutes(times);
    const minDur  = parseInt($('#min-duration').value,10) || 60;
    const needN   = Math.max(1, Math.round(minDur/slotMin));

    DAYS.forEach(day=>{
      const busy = new Set();
      times.forEach(t=>{
        if( (schedules.mochito?.[day]?.[t]) || (schedules.mochita?.[day]?.[t]) ){
          busy.add(t);
        }
      });
      let run = [];
      const flush = ()=>{
        if(run.length>=needN){
          const first = run[0], last = run[run.length-1];
          const item = document.createElement('div');
          item.className='common-slot';
          item.textContent = `${day}: ${first} ‚Äî ${last}`;
          list.appendChild(item);
        }
        run=[];
      };
      times.forEach(t=>{
        if(!busy.has(t)){ run.push(t); } else { flush(); }
      });
      flush();
    });

    if(!list.children.length){
      list.innerHTML = '<div class="common-slot">No encontramos huecos con esa duraci√≥n. Prueba bajando la duraci√≥n m√≠nima.</div>';
    }
  }

  // ========================
  // Exportar / Importar
  // ========================
  function exportJSON(){
    const data = { schedules, customTimes };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'horarios_mochitos.json';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const obj = JSON.parse(e.target.result);
        if(!obj || typeof obj!=='object') throw new Error('Bad JSON');
        schedules = obj.schedules || { mochito:{}, mochita:{} };
        customTimes = obj.customTimes || { mochito:[], mochita:[] };
        renderTable();
        alert('Importado correctamente ‚úÖ (no olvides Guardar Cambios)');
      }catch(err){
        alert('Archivo inv√°lido.');
      }
    };
    reader.readAsText(file,'utf-8');
  }

  // ========================
  // Men√∫ contextual (clic derecho)
  // ========================
  const ctx = $('#context-menu');
  let ctxCell = null;

  function openContextMenu(x,y,cell){
    ctxCell = cell;
    const day  = cell.dataset.day;
    const time = cell.dataset.time;
    const hasM = !!(schedules.mochito?.[day]?.[time]);
    const hasC = !!(schedules.mochita?.[day]?.[time]);

    let html = `<div class="cm-header">${day} ¬∑ ${time}</div>`;

    const addBtn = (id, icon, text, disabled=false)=>(
      `<button data-cmd="${id}" ${disabled?'disabled':''} ${disabled?'style="opacity:.5;cursor:not-allowed"':''}>
         <i class="${icon}"></i> ${text}
       </button>`
    );

    if(currentUser==='mochito'){
      html += addBtn('edit_m','fa-regular fa-pen-to-square','Editar (Mochito)') +
              addBtn('del_m','fa-regular fa-trash-can','Eliminar (Mochito)', !hasM);
    }else if(currentUser==='mochita'){
      html += addBtn('edit_c','fa-regular fa-pen-to-square','Editar (Mochita)') +
              addBtn('del_c','fa-regular fa-trash-can','Eliminar (Mochita)', !hasC);
    }else{ // both -> ofrecer opciones para ambos
      html += addBtn('edit_m','fa-regular fa-pen-to-square','Editar como Mochito') +
              addBtn('edit_c','fa-regular fa-pen-to-square','Editar como Mochita') +
              '<div class="cm-sep"></div>' +
              addBtn('del_m','fa-regular fa-trash-can','Eliminar (Mochito)', !hasM) +
              addBtn('del_c','fa-regular fa-trash-can','Eliminar (Mochita)', !hasC);
    }

    ctx.innerHTML = html;
    ctx.style.display='block';
    positionContextMenu(x,y);

    // listeners
    ctx.querySelectorAll('button[data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const cmd = btn.dataset.cmd;
        const d = ctxCell.dataset.day, t = ctxCell.dataset.time;
        if(cmd==='edit_m') openEditModal(ctxCell, 'mochito');
        if(cmd==='edit_c') openEditModal(ctxCell, 'mochita');
        if(cmd==='del_m'){ deleteActivityFor('mochito', d, t); closeContextMenu(); }
        if(cmd==='del_c'){ deleteActivityFor('mochita', d, t); closeContextMenu(); }
      });
    });
  }

  function positionContextMenu(x,y){
    const rect = ctx.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;
    let left = x, top = y;
    if(left + rect.width > vw - 8) left = vw - rect.width - 8;
    if(top  + rect.height > vh - 8) top  = vh - rect.height - 8;
    ctx.style.left = left + 'px';
    ctx.style.top  = top  + 'px';
  }

  function closeContextMenu(){
    ctx.style.display='none';
    ctxCell = null;
  }

  // ========================
  // Listeners UI
  // ========================
  document.addEventListener('DOMContentLoaded', ()=>{
    loadSchedules();

    // Toggler usuario para editar
    $$('.user-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        $$('.user-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        currentUser = b.dataset.user;

        // sincroniza vista
        $$('.view-btn').forEach(x=>x.classList.remove('active'));
        if(currentUser==='both'){
          currentView='week';
          $('.view-btn[data-view="week"]').classList.add('active');
        }else{
          currentView=currentUser;
          $(`.view-btn[data-view="${currentView}"]`).classList.add('active');
        }
        renderTable();
      });
    });

    // Toggler de vista
    $$('.view-btn').forEach(b=>{
      b.addEventListener('click',()=>{
        $$('.view-btn').forEach(x=>x.classList.remove('active'));
        b.addEventListener
        b.classList.add('active');
        currentView = b.dataset.view;
        renderTable();
      });
    });

    // Paleta color
    $('#activity-color').addEventListener('input', (e)=>{ selectedColor = e.target.value; });

    // A√±adir hora
    $('#add-time-btn').addEventListener('click',()=>{
      const h = parseInt($('#custom-hour').value,10); const m = parseInt($('#custom-minute').value,10);
      if(isNaN(h)||h<0||h>23 || isNaN(m)||m<0||m>59){ alert('Hora inv√°lida'); return; }
      let target = currentUser==='both' ? 'mochito' : currentUser;
      const time = fmt(h,m);
      if(!customTimes[target].includes(time)){
        customTimes[target].push(time);
        customTimes[target] = uniqSorted(customTimes[target]);
        renderTable();
      }
      $('#custom-hour').value=''; $('#custom-minute').value='';
    });

    // Modal Editar
    $('#cancel-btn').addEventListener('click', closeEditModal);
    $('#confirm-btn').addEventListener('click', saveActivity);
    $('#delete-btn').addEventListener('click', deleteActivity);
    $('#event-modal').addEventListener('click', (e)=>{ if(e.target.id==='event-modal') closeEditModal(); });

    // Guardar
    $('#save-btn').addEventListener('click', saveSchedules);

    // Huecos comunes
    $('#btn-common-slots').addEventListener('click', openCommonModal);
    $('#close-common').addEventListener('click', closeCommonModal);
    $('#refresh-common').addEventListener('click', computeCommonSlots);
    $('#common-slots-modal').addEventListener('click',(e)=>{ if(e.target.id==='common-slots-modal') closeCommonModal(); });

    // Export / Import
    $('#btn-export').addEventListener('click', exportJSON);
    $('#import-file').addEventListener('change',(e)=>{
      const f = e.target.files?.[0]; if(f) importJSON(f);
      e.target.value='';
    });

    // Cerrar men√∫ contextual
    document.addEventListener('click', (e)=>{
      if(e.target.closest('#context-menu')) return;
      closeContextMenu();
    });
    window.addEventListener('scroll', closeContextMenu, {passive:true});
    window.addEventListener('resize', closeContextMenu);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeContextMenu(); });
  });
</script>
</body>
</html>
